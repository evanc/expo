{"version":3,"file":"configureAndroidSplashScreen.js","sourceRoot":"","sources":["../src/configureAndroidSplashScreen.ts"],"names":[],"mappings":"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","sourcesContent":["import path from 'path';\nimport fs from 'fs-extra';\nimport chalk from 'chalk';\nimport { projectConfig } from '@react-native-community/cli-platform-android';\n\nimport { Mode } from './constants';\n\nconst DRAWABLES_CONFIGS = {\n  drawable: {\n    multiplier: 1,\n  },\n  'drawable-mdpi': {\n    multiplier: 1,\n  },\n  'drawable-hdpi': {\n    multiplier: 1.5,\n  },\n  'drawable-xhdpi': {\n    multiplier: 2,\n  },\n  'drawable-xxhdpi': {\n    multiplier: 3,\n  },\n  'drawable-xxxhdpi': {\n    multiplier: 4,\n  },\n};\n\nconst SPLASH_SCREEN_DRAWABLE_FILENAME = 'splash_screen_image.png';\nconst SPLASH_SCREEN_XML_FILENAME = 'splash_screen.xml';\n\n/**\n * Modifies file's content if either `replacePattern` or `insertPattern` matches.\n * If `replacePatten` matches `replaceContent` is used, otherwise if `insertPattern` matches `insertContent` is used.\n * @returns `true` if the file's content is changes, `false` otherwise.\n */\nasync function replaceOrInsertInFile(\n  filePath: string,\n  {\n    replaceContent,\n    replacePattern,\n    insertContent,\n    insertPattern,\n  }: {\n    replaceContent: string;\n    replacePattern: RegExp | string;\n    insertContent: string;\n    insertPattern: RegExp | string;\n  }\n): Promise<boolean> {\n  return (\n    replaceInFile(filePath, { replaceContent, replacePattern }) ||\n    insertToFile(filePath, { insertContent, insertPattern })\n  );\n}\n\n/**\n * Tries to do following actions:\n * - when file doesn't exist - create it with given fileContent,\n * - when file does exist and contains provided replacePattern - replace replacePattern with replaceContent,\n * - when file does exist and doesn't contain provided replacePattern - insert given insertContent before first match of insertPattern,\n * - when insertPattern does not occur in the file - append insertContent to the end of the file.\n */\nasync function writeOrReplaceOrInsertInFile(\n  filePath: string,\n  {\n    fileContent,\n    replaceContent,\n    replacePattern,\n    insertContent,\n    insertPattern,\n  }: {\n    fileContent: string;\n    replaceContent: string;\n    replacePattern: RegExp | string;\n    insertContent: string;\n    insertPattern: RegExp | string;\n  }\n) {\n  if (!(await fs.pathExists(filePath))) {\n    return await writeToFile(filePath, fileContent);\n  }\n\n  if (\n    await replaceOrInsertInFile(filePath, {\n      replaceContent,\n      replacePattern,\n      insertContent,\n      insertPattern,\n    })\n  ) {\n    return;\n  }\n\n  const originalFileContent = await fs.readFile(filePath, 'utf8');\n  return await fs.writeFile(filePath, `${originalFileContent}${insertPattern}`);\n}\n\n/**\n * Overrides or creates file (with possibly missing directories) with given content.\n */\nasync function writeToFile(filePath: string, fileContent: string) {\n  const fileDirnamePath = path.dirname(filePath);\n  if (!(await fs.pathExists(fileDirnamePath))) {\n    await fs.mkdirp(fileDirnamePath);\n  }\n  return await fs.writeFile(filePath, fileContent);\n}\n\n/**\n * @returns `true` if replacement is successful, `false` otherwise.\n */\nasync function replaceInFile(\n  filePath: string,\n  { replaceContent, replacePattern }: { replaceContent: string; replacePattern: string | RegExp }\n) {\n  const originalFileContent = await fs.readFile(filePath, 'utf8');\n\n  const replacePatternOccurrence = originalFileContent.search(replacePattern);\n  if (replacePatternOccurrence !== -1) {\n    await fs.writeFile(filePath, originalFileContent.replace(replacePattern, replaceContent));\n    return true;\n  }\n  return false;\n}\n\n/**\n * @returns `true` if insertion is successful, `false` otherwise.\n */\nasync function insertToFile(\n  filePath: string,\n  { insertContent, insertPattern }: { insertContent: string; insertPattern: RegExp | string }\n) {\n  const originalFileContent = await fs.readFile(filePath, 'utf8');\n  const insertPatternOccurrence = originalFileContent.search(insertPattern);\n  if (insertPatternOccurrence !== -1) {\n    await fs.writeFile(\n      filePath,\n      `${originalFileContent.slice(\n        0,\n        insertPatternOccurrence\n      )}${insertContent}${originalFileContent.slice(insertPatternOccurrence)}`\n    );\n    return true;\n  }\n  return false;\n}\n\n/**\n * Deletes all previous splash_screen_images and copies new one to desired drawable directory.\n * @see https://developer.android.com/training/multiscreen/screendensities\n */\nasync function configureSplashScreenDrawables(\n  androidMainResPath: string,\n  splashScreenImagePath: string\n) {\n  Promise.all(\n    Object.keys(DRAWABLES_CONFIGS)\n      .map(drawableDirectoryName =>\n        path.resolve(androidMainResPath, drawableDirectoryName, SPLASH_SCREEN_DRAWABLE_FILENAME)\n      )\n      .map(async drawablePath => {\n        if (await fs.pathExists(drawablePath)) {\n          await fs.remove(drawablePath);\n        }\n      })\n  );\n\n  await fs.mkdir(path.resolve(androidMainResPath, 'drawable'));\n  await fs.copyFile(\n    splashScreenImagePath,\n    path.resolve(androidMainResPath, 'drawable', SPLASH_SCREEN_DRAWABLE_FILENAME)\n  );\n}\n\n/**\n * Configures or creates splash screen's:\n * - background color in colors.xml\n * - xml drawable file\n * - style with theme including 'android:windowBackground' in styles.xml\n * - theme for activity in AndroidManifest.xml\n */\nasync function configureSplashScreenXML(\n  androidMainPath: string,\n  mode: Mode,\n  splashScreenBackgroundColor: string\n) {\n  const androidMainResPath = path.resolve(androidMainPath, 'res');\n\n  // colors.xml\n  // TODO: maybe it's possible to move it to separate fully-controlled-by-this-script file?\n  await writeOrReplaceOrInsertInFile(path.resolve(androidMainResPath, 'values', 'colors.xml'), {\n    fileContent: `<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<resources>\n  <color name=\"splashScreenBackgroundColor\">${splashScreenBackgroundColor}</color> <!-- HANDLED BY \\'expo-splash-screen\\' COMMAND -->'\n</resources>\n`,\n\n    replaceContent: `  <color name=\"splashScreenBackgroundColor\">${splashScreenBackgroundColor}</color> <!-- HANDLED BY 'expo-splash-screen' COMMAND -->\n`,\n    replacePattern: /^(.*?)<color name=\"splashScreenBackgroundColor\">(.+?)<\\/color>(.*?)$/m,\n\n    insertContent: `  <color name=\"splashScreenBackgroundColor\">${splashScreenBackgroundColor}</color> <!-- HANDLED BY 'expo-splash-screen' COMMAND -->\n`,\n    insertPattern: /^(.*?)<\\/resources>(.*?)$/m,\n  });\n\n  // xml drawable file\n  const nativeSplashScreen: string =\n    mode !== Mode.NATIVE\n      ? ''\n      : `\n  <item>\n    <bitmap\n      android:gravity=\"center\"\n      android:src=\"@drawable/splash_screen_image\"\n    />\n  </item>\n`;\n\n  await writeToFile(\n    path.resolve(androidMainResPath, 'drawable', SPLASH_SCREEN_XML_FILENAME),\n    `<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<!--\n\n    THIS FILE IS CREATED BY 'expo-splash-screen' COMMAND\n\n-->\n<layer-list xmlns:android=\"http://schemas.android.com/apk/res/android\">\n  <item android:drawable=\"@color/splashScreenBackgroundColor\"/>${nativeSplashScreen}\n</layer-list>\n`\n  );\n\n  // styles.xml\n  // TODO: separate file\n  await writeOrReplaceOrInsertInFile(path.resolve(androidMainResPath, 'values', 'styles.xml'), {\n    fileContent: `<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<resources>\n  <style name=\"Theme.App.SplashScreen\" parent=\"Theme.AppCompat.Light.NoActionBar>\n    <item name=\"android:windowBackground\">@drawable/splash_screen</item>\n  </style>\n</resources>\n`,\n\n    replaceContent: `    <item name=\"android:windowBackground\">@drawable/splash_screen</item> <!-- HANDLED BY 'expo-splash-screen' COMMAND -->`,\n    replacePattern: /(?<=(?<styleNameLine>^.*?(?<styleName><style name=\"Theme\\.App\\.SplashScreen\" parent=\".*?\">).*?$\\n)(?<linesBeforeWindowBackgroundLine>(?<singleBeforeLine>^.*$\\n)*?))(?<windowBackgroundLine>^.*?(?<windowBackground><item name=\"android:windowBackground\">.*<\\/item>).*$\\n)(?=(?<linesAfterWindowBackgroundLine>(?<singleAfterLine>^.*$\\n)*?)(?<closingTagLine>^.*?<\\/style>.*?$\\n))/m,\n\n    insertContent: `  <style name=\"Theme.App.SplashScreen\" parent=\"Theme.AppCompat.Light.NoActionBar\">\n    <item name=\"android:windowBackground\">@drawable/splash_screen</item>\n  </style>\n`,\n    insertPattern: /^(.*?)<\\/resources>(.*?)$/m,\n  });\n\n  // AndroidManifest.xml\n  // TODO: assumption that MainActivity is entry point\n  if (\n    !(await replaceOrInsertInFile(path.resolve(androidMainPath, 'AndroidManifest.xml'), {\n      replaceContent: `\\n    android:theme=\"@style/Theme.App.Splash\" <!-- HANDLED BY 'expo-splash-screen' COMMAND -->\\n`,\n      replacePattern: /(?<=(?<applicationPart>^.*?<application(.*|\\n)*?)(?<activity>^.*?<activity(.|\\n)*?android:name=\"\\.MainActivity\"(.|\\n)*?))(?<androidTheme>\\s*?android:theme=\".*?\"\\s*)/m,\n\n      insertContent: `\\n    android:theme=\"@style/Theme.App.Splash\" <!-- HANDLED BY 'expo-splash-screen' COMMAND -->\\n`,\n      insertPattern: /(?<=(?<applicationPart>^.*?<application(.*|\\n)*?)(?<activity>^.*?<activity(.|\\n)*?android:name=\"\\.MainActivity\"(.|\\n)*?))(?<insertMatch>>)/m,\n    }))\n  ) {\n    console.log(\n      chalk.yellow(\n        `${chalk.magenta(\n          'AndroidManifest.xml'\n        )} does not contain <activity /> entry for ${chalk.magenta(\n          'MainActivity'\n        )}. SplashScreen style will not be applied.`\n      )\n    );\n  }\n}\n\n/**\n * Injects specific code to MainApplication that would trigger SplashScreen.\n * TODO: make it work\n */\nasync function configureShowingSplashScreen(projectRootPath: string) {\n  // const mainAndroidFilePath = projectConfig(projectRootPath)?.mainFilePath;\n}\n\nexport default async function configureAndroidSplashScreen(imagePath: string, mode: Mode) {\n  const splashScreenBackgroundColor = `#FFFFFF`;\n  const projectRootPath = path.resolve();\n  const androidMainPath = path.resolve(projectRootPath, 'android/app/src/main');\n\n  return Promise.all([\n    await configureSplashScreenDrawables(path.resolve(androidMainPath, 'res'), imagePath),\n    await configureSplashScreenXML(androidMainPath, mode, splashScreenBackgroundColor),\n    await configureShowingSplashScreen(projectRootPath),\n  ]).then(() => {});\n}\n"]}